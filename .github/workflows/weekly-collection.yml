name: Weekly Data Collection

on:
  schedule:
    # æ¯é€±å…­ 10:00 å°ç£æ™‚é–“åŸ·è¡Œ (UTC+8 = 02:00 UTC)
    - cron: '0 2 * * 6'
  workflow_dispatch:
    inputs:
      date:
        description: 'æ”¶é›†æ—¥æœŸ (YYYY-MM-DDï¼Œç•™ç©ºç‚ºæ˜¨å¤©)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  collect-weekly:
    name: Collect Weekly Data
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set collection date
        id: date
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            echo "date=${{ github.event.inputs.date }}" >> $GITHUB_OUTPUT
          else
            echo "date=yesterday" >> $GITHUB_OUTPUT
          fi

      - name: Pull Docker image
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:phase1-latest

      - name: Collect ownership data (è‚¡æ¬Šåˆ†æ•£è¡¨)
        env:
          FINMIND_API_TOKEN: ${{ secrets.FINMIND_API_TOKEN }}
          COLLECTION_DATE: ${{ steps.date.outputs.date }}
        run: |
          docker run --rm \
            -e FINMIND_API_TOKEN="${FINMIND_API_TOKEN}" \
            -e COLLECTION_DATE="${COLLECTION_DATE}" \
            -e TZ=Asia/Taipei \
            -v ${{ github.workspace }}/data:/app/data \
            -v ${{ github.workspace }}/logs:/app/logs \
            -v ${{ github.workspace }}/cache:/app/cache \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:phase1-latest \
            python scripts/run_collection.py --date ${COLLECTION_DATE} --types ownership

      - name: Collect revenue data (æœˆç‡Ÿæ”¶)
        if: success() || failure()
        env:
          FINMIND_API_TOKEN: ${{ secrets.FINMIND_API_TOKEN }}
        run: |
          # æœˆç‡Ÿæ”¶é€šå¸¸åœ¨æ¯æœˆ 10 æ—¥å‰å…¬å¸ƒ
          CURRENT_DAY=$(date +%d)
          if [ "$CURRENT_DAY" -le 10 ]; then
            docker run --rm \
              -e FINMIND_API_TOKEN="${FINMIND_API_TOKEN}" \
              -e TZ=Asia/Taipei \
              -v ${{ github.workspace }}/data:/app/data \
              -v ${{ github.workspace }}/logs:/app/logs \
              -v ${{ github.workspace }}/cache:/app/cache \
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:phase1-latest \
              python scripts/run_collection.py --types revenue
          else
            echo "â­ï¸ è·³éæœˆç‡Ÿæ”¶æ”¶é›†ï¼ˆéå…¬å¸ƒæœŸé–“ï¼‰"
          fi

      - name: Check collected data
        run: |
          echo "=== æ¯é€±è³‡æ–™æ”¶é›†çµæœ ==="
          echo ""
          echo "è‚¡æ¬Šåˆ†æ•£è¡¨:"
          find data/raw/ownership -type f -name "*.json" -o -name "*.csv" | tail -10
          echo ""
          echo "æœˆç‡Ÿæ”¶:"
          find data/raw/revenue -type f -name "*.json" -o -name "*.csv" 2>/dev/null | tail -10 || echo "ç„¡æœˆç‡Ÿæ”¶è³‡æ–™"

      - name: Commit and push data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if [ "${{ steps.date.outputs.date }}" = "yesterday" ]; then
            COMMIT_DATE=$(date -d "yesterday" +%Y-%m-%d 2>/dev/null || date -v-1d +%Y-%m-%d)
          else
            COMMIT_DATE="${{ steps.date.outputs.date }}"
          fi

          git add data/raw/ logs/

          if git diff --staged --quiet; then
            echo "æ²’æœ‰æ–°è³‡æ–™éœ€è¦æäº¤"
          else
            git commit -m "data: Weekly collection for ${COMMIT_DATE}

Collected data:
- Ownership (è‚¡æ¬Šåˆ†æ•£è¡¨)
- Revenue (æœˆç‡Ÿæ”¶ï¼Œå¦‚é©ç”¨)

ğŸ¤– Automated weekly collection by GitHub Actions"

            git push
            echo "âœ… æ¯é€±è³‡æ–™å·²æäº¤"
          fi

      - name: Upload collection logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-collection-logs
          path: logs/
          retention-days: 30
