version: '3.8'

services:
  # Phase 1 測試服務
  phase1-test:
    image: ghcr.io/twcs-analysis/tw-stock-collector:phase1-latest
    container_name: tw-stock-phase1-test
    environment:
      - TZ=Asia/Taipei
    volumes:
      # 掛載資料目錄（保留測試結果）
      - ./data:/app/data
      - ./logs:/app/logs
      - ./cache:/app/cache
    command: python scripts/test_refactored_collector.py
    networks:
      - stock-network

  # Phase 1 收集服務（用於實際收集）
  phase1-collector:
    image: ghcr.io/twcs-analysis/tw-stock-collector:phase1-latest
    container_name: tw-stock-phase1-collector
    environment:
      - TZ=Asia/Taipei
      - COLLECTION_DATE=${COLLECTION_DATE:-yesterday}
      - COLLECTION_TYPES=${COLLECTION_TYPES:-price}
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./cache:/app/cache
    command: >
      sh -c "
      echo '開始收集資料（使用官方 API，無需股票清單）...' &&
      python scripts/run_collection.py --date $${COLLECTION_DATE} --types $${COLLECTION_TYPES}
      "
    networks:
      - stock-network
    profiles:
      - collection

  # Phase 1 回補服務
  phase1-backfill:
    image: ghcr.io/twcs-analysis/tw-stock-collector:phase1-latest
    container_name: tw-stock-phase1-backfill
    environment:
      - TZ=Asia/Taipei
      - START_DATE=${START_DATE:-2025-01-01}
      - END_DATE=${END_DATE:-}
      - BACKFILL_DAYS=${BACKFILL_DAYS:-7}
      - BACKFILL_TYPES=${BACKFILL_TYPES:-price}
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./cache:/app/cache
    command: >
      sh -c "
      echo '開始回補資料（使用官方 API）...' &&
      if [ -n \"$${END_DATE}\" ]; then
        python scripts/backfill.py --start $${START_DATE} --end $${END_DATE} --types $${BACKFILL_TYPES}
      else
        python scripts/backfill.py --start $${START_DATE} --days $${BACKFILL_DAYS} --types $${BACKFILL_TYPES}
      fi
      "
    networks:
      - stock-network
    profiles:
      - backfill

networks:
  stock-network:
    driver: bridge
