version: '3.8'

services:
  # Phase 1 測試服務
  phase1-test:
    image: ghcr.io/twcs-analysis/tw-stock-collector:phase1-latest
    container_name: tw-stock-phase1-test
    environment:
      - FINMIND_API_TOKEN=${FINMIND_API_TOKEN:-}
      - TZ=Asia/Taipei
    volumes:
      # 掛載資料目錄（保留測試結果）
      - ./data:/app/data
      - ./logs:/app/logs
      - ./cache:/app/cache
    command: python scripts/test_phase1.py --skip-api
    networks:
      - stock-network

  # Phase 1 收集服務（用於實際收集）
  phase1-collector:
    image: ghcr.io/twcs-analysis/tw-stock-collector:phase1-latest
    container_name: tw-stock-phase1-collector
    environment:
      - FINMIND_API_TOKEN=${FINMIND_API_TOKEN:-}
      - TZ=Asia/Taipei
      - COLLECTION_DATE=${COLLECTION_DATE:-yesterday}
      - COLLECTION_TYPES=${COLLECTION_TYPES:-price institutional margin lending}
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./cache:/app/cache
    command: >
      sh -c "
      echo '準備股票清單...' &&
      if [ -f data/reference/stock_list_reference.csv ]; then
        echo '使用參考股票清單 (data/reference/stock_list_reference.csv)' &&
        cp data/reference/stock_list_reference.csv data/stock_list.csv &&
        echo '已複製參考清單到 data/stock_list.csv'
      else
        echo '警告: 找不到參考股票清單，將使用現有 data/stock_list.csv 或從 API 獲取'
      fi &&
      echo '開始收集資料...' &&
      python scripts/run_collection.py --date $${COLLECTION_DATE} --types $${COLLECTION_TYPES}
      "
    networks:
      - stock-network
    profiles:
      - collection

  # Phase 1 回補服務
  phase1-backfill:
    image: ghcr.io/twcs-analysis/tw-stock-collector:phase1-latest
    container_name: tw-stock-phase1-backfill
    environment:
      - FINMIND_API_TOKEN=${FINMIND_API_TOKEN:-}
      - TZ=Asia/Taipei
      - START_DATE=${START_DATE:-2025-01-01}
      - END_DATE=${END_DATE:-}
      - BACKFILL_DAYS=${BACKFILL_DAYS:-7}
      - BACKFILL_TYPES=${BACKFILL_TYPES:-price institutional margin lending}
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./cache:/app/cache
    command: >
      sh -c "
      echo '準備股票清單...' &&
      if [ -f data/reference/stock_list_reference.csv ]; then
        echo '使用參考股票清單 (data/reference/stock_list_reference.csv)' &&
        cp data/reference/stock_list_reference.csv data/stock_list.csv &&
        echo '已複製參考清單到 data/stock_list.csv'
      else
        echo '警告: 找不到參考股票清單，將使用現有 data/stock_list.csv 或從 API 獲取'
      fi &&
      echo '開始回補資料...' &&
      if [ -n \"$${END_DATE}\" ]; then
        python scripts/backfill.py --start $${START_DATE} --end $${END_DATE} --types $${BACKFILL_TYPES}
      else
        python scripts/backfill.py --start $${START_DATE} --days $${BACKFILL_DAYS} --types $${BACKFILL_TYPES}
      fi
      "
    networks:
      - stock-network
    profiles:
      - backfill

networks:
  stock-network:
    driver: bridge
